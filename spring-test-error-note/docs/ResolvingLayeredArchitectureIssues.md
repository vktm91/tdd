# TDD와 레이어드 아키텍처의 문제점 및 해결책

### H2 데이터베이스를 테스트에 사용하는 것의 의미
- **중형 테스트가 된다**: H2 같은 인-메모리 데이터베이스를 사용하는 것은 전체적인 시스템 통합을 확인하는 중형 테스트에 해당한다.
- **제한된 DB 테스트 가능성**: RDBMS는 테스트가 가능하지만, Elasticsearch와 같은 특정 DB는 임베디드 서버가 없어 자동화된 테스트 구현이 어렵다.
- **설계 오류 가능성**: 데이터베이스 중심의 설계가 이루어졌다는 징후로, 이는 설계 자체에 문제가 있을 수 있음을 의미한다.
- **테스트의 본질 문제**: 현재 진행 중인 테스트가 실제 필요한 핵심 테스트가 아닐 가능성이 있다.

### 레이어드 아키텍처의 단점
- **데이터베이스 주도 설계 유도**: 시스템 설계 시 데이터베이스나 영속성 계층부터 고려하는 경향이 있으며, 이는 절차적 사고를 유도할 수 있다.
  - 예: 주문 시스템을 설계할 때, order 엔티티가 아닌 필요한 사용 사례(use case)부터 고려해야 하지만, order 엔티티를 먼저 떠올리게 된다.
- **의존성 고민 부족**: 레이어드 아키텍처는 각 계층 간의 의존성 문제에 대한 충분한 고민을 유도하지 않는다.
- **도메인 가치 감소**: 비즈니스 문제를 해결하는 핵심 도메인 객체인 도메인이 설계에서 중요성을 잃어버린다.
- **동시 작업 제한**: 특정 기능의 개발이 한 사람에 의해서만 수행되어야 하는 경우가 많아, 팀 작업의 효율성이 떨어진다.
- **규모 확장성 저하**: 시스템이 커질수록 확장성이 떨어지며, 이는 유지보수와 업데이트를 어렵게 만든다.


## 개선된 아키텍처

### 도메인 레이어 추가
- 도메인 레이어를 추가하여 기존에 서비스 계층에서 수행되던 비즈니스 로직을 도메인 계층으로 위임한다. 
  - 도메인 엔티티와 영속성 객체를 구분하는 것이다. 
  - 도메인 엔티티는 비즈니스 로직을, 영속성 객체는 데이터 접근 로직을 담당한다.
- 서비스 계층은 주로 도메인 객체를 repository에서 가져와 그 객체에게 적절한 책임을 위임하는 역할만 하게한다.
- 도메인 모델은 lombok을 제외한 어노테이션이 달려있지 않게 한다.
- 이렇게 하면 SOLID 원칙과 동시작업 문제가 해결된다.

### 낮은 testability 해결 방법
### Domain
- 도메인은 계층 간 연결된 의존성이 없다.
- 그렇기때 문에 계층 간 의존성을 위해 mocking을 할 필요가 없어진다.
- 그리고 도메인은 그자체로 순수 java코드이기 때문에 인스턴스로 만들기 쉽다.

### Repository
- repository도 의존된 다른 계층이 없기 때문에 계층간 의존성을 위해 mocking할 필요가 없다.
- 근데 사실 jpaRepository는 테스트할 필요가 없지않을까? jpa에서 알아서 테스트하고 있을테니까.

### Service
- 서비스는 domain, jpaRepository와 의존성이 있다.
- 도메인은 순수 java 코드로 되어있어 인스턴스화 하는 것이 어렵지 않을 것이기 때문에 서비스를 테스트 하는데 있어 도메인은 방해 요인이 아니다.
- 그러나 repository가 문제다. repository는 java가 아닌 jpa코드를 사용하고 있고, db와 강결합 되어있다.
- 그래서 repostiory를 인스턴스화 하는 것은 h2같은 embedded db 없이 인스턴스화 하는것이 어렵다.
- 따라서 repository를 해결해야하는데 의존성으로 발생하는 문제는 의존성역전으로 대부분 해결된다.

> 의존성 역전으로 service의 repository 의존성 문제 해결하기:
- 비즈니스 레이어에 repository interface를 위치 시키고, repository interface의 구현체를 영속성 계층에 위치시킨다.
- 구현체가 jpaRepository를 사용한다.
- 여기서 테스트할 땐, Persistence에서 FakeRepository를 사용함으로써 Testability를 높일 수 있게 된다.
- 또한 repository뿐만아니라 모든 외부 연동도 영속성 레이어에 위치하여 이 규칙을 지키게한다.
- 그래서 영속성 레이어는 infrastructure가 된다.

### Controller
- 컨트롤러는 인스턴스화는 쉽지만, 의존성이 3개이기 때문에 역시 의존성 역전을 사용한다.

> 의존성 역전으로 controller의 service, repository, domain 의존성 문제 해결하기
- Service를 인터페이스로 만들고 Service 구현체를 둔다.
- 테스트할 땐, Service에 대응되는 Fake나 Mock을 Service 구현체로 두게 하여 Controller를 테스트하기 쉽게 만든다.
